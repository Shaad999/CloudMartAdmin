<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<title>Cloud Mart - Admin (Firebase)</title>
<style>
/* --- আপনার আগের স্টাইল বজায় রাখা হলো --- */
body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:0; }
header { background:#333; color:#fff; padding:15px; text-align:center; font-size:22px; }
.container { padding:20px; }
h2 { margin-top:30px; }
input, select, button, textarea { padding:8px; margin:5px 0; border:1px solid #ccc; border-radius:5px; width:100%; box-sizing:border-box; }
table { width:100%; border-collapse:collapse; border-spacing:0; margin-top:15px; }
th, td { border:1px solid #ddd; padding:12px 10px; text-align:center; vertical-align: middle; }
th { background:#555; color:#fff; font-weight:600; }
button { cursor:pointer; transition:0.3s; }
button:hover { transform:scale(1.05); }
.delete { background:#dc3545; color:#fff; border:none; padding:5px 10px; }
.done { background:#28a745; color:#fff; border:none; padding:5px 10px; }
.print { background:#007bff; color:#fff; border:none; padding:5px 10px; }
.edit { background:#ffc107; color:#111; border:none; padding:5px 10px; }
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px; align-items:start; }
img.thumb { width:50px; height:50px; object-fit:cover; border-radius:6px; }
.notice { font-size:13px; color:#444; margin-top:6px; }
tbody tr { opacity:0; transform:translateY(10px); transition:0.4s ease; }
tbody tr.show { opacity:1; transform:translateY(0); }
.small { font-size:13px; padding:6px 8px; }
</style>
</head>
<body>
<header>Cloud Mart - Admin Panel (Firebase)</header>
<div class="container">

  <h2>Payment Method</h2>
  <div style="max-width:420px;">
    <label>Bkash Number:</label>
    <input type="text" id="adminBkash" placeholder="Enter Bkash Number">
    <label>Nagad Number:</label>
    <input type="text" id="adminNagad" placeholder="Enter Nagad Number">
    <div style="display:flex;gap:8px;">
      <button id="savePaymentBtn" style="flex:1">Save Payment Numbers</button>
      <button id="reloadPaymentBtn" style="flex:1">Reload From Firebase</button>
    </div>
    <p class="notice">Payment নম্বর change করলে অবশ্যই Save চাপুন — তা Firebase এ আপডেট হবে।</p>
  </div>

  <h2>Add / Edit Product</h2>
  <form id="productForm">
    <div class="form-grid">
      <input type="text" id="prodName" placeholder="Product Name" required>
      <input type="text" id="prodCategory" placeholder="Category" required>
      <input type="number" id="prodPrice" placeholder="Price" step="0.01" required>
      <input id="prodDescription" placeholder="Product Description" rows="2" required>
      <input type="file" id="prodImage" accept="image/*">
      <div>
        <button type="submit" id="addUpdateBtn">Add Product</button>
        <button type="button" id="cancelEditBtn" style="display:none;margin-left:8px;background:#6c757d;color:#fff;">Cancel Edit</button>
      </div>
    </div>
  </form>

  <h2>Product List</h2>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Category</th>
        <th>Price</th>
        <th>Description</th>
        <th>Image</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="productList"></tbody>
  </table>

  <h2>Orders (Last 5)</h2>
  <table>
    <thead>
      <tr>
        <th>Product</th>
        <th>User</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Payment</th>
        <th>Send Number</th>
        <th>Trnx ID</th>
        <th>Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="orderList"></tbody>
  </table>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCl9ENd3XOP1KeutD7s1zSiXYSuz4VIqGU",
  authDomain: "cloud-mart01.firebaseapp.com",
  databaseURL: "https://cloud-mart01-default-rtdb.firebaseio.com",
  projectId: "cloud-mart01",
  storageBucket: "cloud-mart01.firebasestorage.app",
  messagingSenderId: "656495467691",
  appId: "1:656495467691:web:b0c0f7356b36af5de12bee",
  measurementId: "G-PXLYR809MM"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* DOM refs */
const orderList = document.getElementById('orderList');

/* escape helper */
function escapeHtml(text) {
  if (text === undefined || text === null) return '';
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

/* =======================
   Orders: last 5 + auto remove older
   ======================= */
db.ref('orders').on('value', snap=>{
  const orders = [];
  snap.forEach(child=>{
    orders.push({ key: child.key, ...child.val() });
  });

  // sort by date or push order
  orders.sort((a,b)=>{
    // assuming 'date' is string; else fallback to push order
    if(a.date && b.date) return new Date(a.date) - new Date(b.date);
    return 0;
  });

  // auto remove older orders if more than 5
  if (orders.length > 5) {
    const toRemove = orders.slice(0, orders.length - 5);
    toRemove.forEach(o=>{
      db.ref('orders/' + o.key).remove().catch(console.error);
    });
    orders.splice(0, orders.length - 5); // keep last 5
  }

  // render last 5
  orderList.innerHTML = '';
  orders.forEach((o,i)=>{
    const tr = document.createElement('tr');
    tr.className = 'show';
    tr.innerHTML = `
      <td>${escapeHtml(o.product)}</td>
      <td>${escapeHtml(o.name)}</td>
      <td>${escapeHtml(o.email)}</td>
      <td>${escapeHtml(o.phone)}</td>
      <td>${escapeHtml(o.payment)}</td>
      <td>${escapeHtml(o.sendNumber||'')}</td>
      <td>${escapeHtml(o.trnx||'')}</td>
      <td>${escapeHtml(o.date||'')}</td>
      <td>
        <button class="done small" onclick="markDone('${o.key.replace(/'/g,"\\'")}')">Done</button>
        <button class="print small" onclick="printInvoice('${o.key.replace(/'/g,"\\'")}')">Print</button>
      </td>
    `;
    orderList.appendChild(tr);
    setTimeout(()=> tr.classList.add('show'), 40*i);
  });
});

/* mark done */
window.markDone = function(orderKey) {
  if (!confirm('Mark this order as done (will remove from DB)?')) return;
  db.ref('orders/' + orderKey).remove().catch(e=>{ console.error(e); alert('Failed to remove order.'); });
};

/* print invoice */
window.printInvoice = function(orderKey) {
  db.ref('orders/' + orderKey).once('value').then(snap=>{
    const o = snap.val();
    if(!o) return alert('Order not found');
    const w = window.open('', '', 'width=800,height=600');
    w.document.write(`
      <html><head><title>Admin Invoice</title>
      <style>body{font-family:Arial;padding:20px} h2{text-align:center} p{margin:6px 0}</style>
      </head><body>
      <h2>Cloud Mart Invoice</h2>
      <p><b>Date:</b> ${escapeHtml(o.date||'')}</p>
      <p><b>Name:</b> ${escapeHtml(o.name||'')}</p>
      <p><b>Email:</b> ${escapeHtml(o.email||'')}</p>
      <p><b>Phone:</b> ${escapeHtml(o.phone||'')}</p>
      <p><b>Product:</b> ${escapeHtml(o.product||'')}</p>
      <p><b>Payment:</b> ${escapeHtml(o.payment||'')}</p>
      <p><b>Send Number:</b> ${escapeHtml(o.sendNumber||'')}</p>
      <p><b>Transaction ID:</b> ${escapeHtml(o.trnx||'')}</p>
      <hr><p style="text-align:center">✅ Thank you for your purchase!</p>
      </body></html>
    `);
    w.document.close();
    w.print();
  }).catch(e=>{ console.error(e); alert('Failed to load order'); });
};
</script>
</body>
</html>
